name: Theme Release

on:
  workflow_run:
    workflows: ["Theme Build"] # Run only after CI finishes
    types: [completed]

jobs:
  build-and-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v5

      #---
      # Parse tag
      - name: Parse theme name & version
        id: parse
        shell: bash
        run: |
          TAG=""
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            # When triggered by workflow_run, try to get the ref from the original workflow that completed
            # If the original event was a tag push, the ref will be 'refs/tags/TAG_NAME'
            if [[ "${{ github.event.workflow_run.ref }}" =~ ^refs/tags/ ]]; then
              TAG="${{ github.event.workflow_run.ref }}"
              TAG="${TAG#refs/tags/}" # Remove 'refs/tags/' prefix
            else
              # Fallback for other workflow_run scenarios (e.g., original workflow was on a branch)
              TAG="${{ github.event.workflow_run.head_ref }}"
            fi
          else
            # For direct push events (e.g., tag push directly to this workflow), GITHUB_REF_NAME is correct
            TAG="${GITHUB_REF_NAME}"
          fi
          if [[ "$TAG" =~ ^theme-([a-zA-Z0-9_]+_v[0-9]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            echo "theme_name=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "version=${BASH_REMATCH[2]}" >> $GITHUB_OUTPUT
            echo "theme_path=plugins/gis-theme/${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "Invalid tag format: $TAG"
            exit 1
          fi

      # Verify presence
      - name: Validate theme directory
        run: |
          test -d "${{ steps.parse.outputs.theme_path }}" || {
            echo "Theme not found"
            exit 1
          }

      # Build
      - uses: actions/setup-node@v5
        with:
          node-version: "18"

      - name: Install dependencies
        working-directory: ${{ steps.parse.outputs.theme_path }}
        run: yarn install --frozen-lockfile

      - name: Build theme
        working-directory: ${{ steps.parse.outputs.theme_path }}
        env:
          NODE_OPTIONS: "--loader ts-node/esm"
        run: yarn build

      # ZIP (correct structure)
      - name: Package theme
        id: zip
        shell: bash
        run: |
          THEME="${{ steps.parse.outputs.theme_name }}"
          VERSION="${{ steps.parse.outputs.version }}"
          ZIP_PATH="${GITHUB_WORKSPACE}/${THEME}-${VERSION}.zip"

          cd plugins/gis-theme
          zip -r "$ZIP_PATH" "$THEME" \
            -x "$THEME/node_modules/*" \
            -x "$THEME/.git/*" \
            -x "$THEME/.gitignore" \
            -x "$THEME/yarn.lock" \
            -x "$THEME/package-lock.json" \
            -x "$THEME/**/.DS_Store"

          echo "zip_path=$ZIP_PATH" >> $GITHUB_OUTPUT

      # Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ steps.parse.outputs.theme_name }} v${{ steps.parse.outputs.version }}"
          files: ${{ steps.zip.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
